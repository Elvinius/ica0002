---
- name: Collect information about all VMs
  hosts: all
  tasks:
    - setup:

- name: Ansible connection test
  hosts: all
  roles:
    - test_connection

- name: Setup
  hosts: all
  become: yes
  roles:
    - init

- name: DNS
  hosts: dns_servers
  become: yes
  roles:
    - bind
  tags: bind

- name: Configure Nginx
  hosts: all
  become: yes
  roles:
    - nginx
  tags: nginx

# - name: Backup
#   hosts: all
#   become: yes
#   gather_facts: no
#   roles:
#     - backup
#   tags: backup

- name: db servers
  hosts: db_servers
  become: yes
  gather_facts: no
  roles:
    - mysql
    - mysql_exporter
  tags: mysql

- name: Configure Prometheus
  hosts: all
  become: yes
  roles:
    - prometheus
  tags: prometheus

- name: Internal Machine Play
  hosts: internal_vm
  become: yes
  roles:
    - users
    - grafana
    - docker
    - nginx_exporter
    - influxdb
    - rsyslog
    - grafana_docker
    - backup
    - pinger
  tags:
    - internal

- name: Application Machine Play
  hosts: application_vms
  become: yes
  roles:
    - docker
    - agama_docker
    - haproxy
    - keepalived
    - grafana
    - backup
    - nginx_exporter
    - bind_exporter
    - node_exporter
    - rsyslog
  tags:
    - application

# - name: Nginx
#   hosts: all
#   roles: 
#     - nginx
#   become: yes
#   tags: nginx

# - name: Nginx proxies
#   hosts: all
#   roles:
#     - nginx_exporter
#   become: yes
#   tags: nginx-exporter

# - name: db servers
#   hosts: db_servers
#   become: yes
#   gather_facts: no
#   roles:
#     - mysql
#     - mysql_exporter
#   tags: mysql

# - name: Monitoring and logging
#   hosts: all
#   become: yes
#   gather_facts: no
#   roles:
#     - node_exporter
#     - bind_exporter

# - name: Install InfluxDB and Telegraf
#   hosts: influxdb
#   gather_facts: false
#   become: yes
#   roles:
#     - influxdb

# - name: Configure Rsyslog
#   hosts: prometheus
#   gather_facts: false
#   become: yes
#   roles:
#     - rsyslog

# - name: Transfer and setup pinger script
#   hosts: pinger
#   gather_facts: false
#   become: yes
#   roles:
#     - pinger

# - name: Backup
#   hosts: all
#   become: yes
#   gather_facts: no
#   roles:
#     - backup
#   tags: backup

# - name: Install Grafana
#   hosts: grafana
#   become: yes
#   roles:
#     - grafana
#   tags: grafana

# - name: docker
#   hosts: docker_servers
#   gather_facts: false
#   become: yes
#   roles:
#     - docker
#   tags: docker

# - name: Setup Grafana Docker container
#   hosts: grafana
#   gather_facts: no
#   become: yes
#   roles:
#     - grafana_docker
#   tags: grafana_docker

# - name: Setup Agama Docker container
#   hosts: app_servers
#   gather_facts: no
#   become: yes
#   roles:
#     - agama_docker

# - name: HAProxy
#   hosts: haproxy
#   gather_facts: true
#   become: yes
#   roles: 
#     - haproxy
#   tags: haproxy

# - name: Keepalived
#   hosts: haproxy
#   gather_facts: true
#   become: yes
#   roles: 
#     - keepalived
#   tags: keepalived